<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contrato Interativo – Studio D & Matheus Laurindo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- 
      Application Structure Plan: Migrated from localStorage to Firestore for robust, real-time data persistence.
      - Admin settings, current client data, and client history are now stored in Firestore collections.
      - This allows for data to be saved across sessions and potentially shared/managed by multiple authenticated users.
      - The core tabbed-dashboard structure remains, but the data layer is now asynchronous and more powerful.
      - `onSnapshot` listeners are used to update the UI in real-time as data changes in the database.
      - All `alert()` calls have been replaced with a custom, non-blocking notification system.
    -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-button.active {
            border-color: #14b8a6;
            color: #14b8a6;
            background-color: #f0fdfa;
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
        }
        .price-box.active {
            border-color: #14b8a6;
            background-color: #f0fdfa;
            transform: scale(1.02);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .price-box {
            transition: all 0.3s ease-in-out;
        }
        .price-box.inactive {
            filter: grayscale(80%);
            opacity: 0.7;
        }
        .chart-container {
            position: relative;
            height: 120px;
            max-height: 120px;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .signature-canvas {
            border: 1px solid #e2e8f0;
            background-color: #ffffff;
            cursor: crosshair;
            touch-action: none;
        }
        .input-group {
            margin-bottom: 1rem;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #334155;
        }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            font-size: 1rem;
            color: #1e293b;
            background-color: #f8fafc;
        }
        .form-section.hidden, .admin-section.hidden {
            display: none;
        }
        /* Custom Notification Toast */
        #notification-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            z-index: 1000;
        }
        #notification-toast.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -10px);
        }
        #notification-toast.success { background-color: #10b981; }
        #notification-toast.error { background-color: #ef4444; }
        #notification-toast.info { background-color: #3b82f6; }

        /* Loading Spinner */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #14b8a6;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <div id="notification-toast"></div>

    <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-teal-600">Contrato de Gestão de Tráfego Pago</h1>
            <p id="header-subtitle" class="text-slate-500 mt-2">Studio D & Matheus Henrique Laurindo</p>
        </header>

        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
            <nav class="flex flex-wrap border-b border-slate-200 mb-6">
                <button data-tab="overview" class="tab-button active text-sm sm:text-base font-medium py-3 px-3 sm:px-5 border-b-2 border-transparent hover:border-teal-500 hover:text-teal-500">Visão Geral</button>
                <button data-tab="parties" class="tab-button text-sm sm:text-base font-medium py-3 px-3 sm:px-5 border-b-2 border-transparent hover:border-teal-500 hover:text-teal-500">Partes</button>
                <button data-tab="services" class="tab-button text-sm sm:text-base font-medium py-3 px-3 sm:px-5 border-b-2 border-transparent hover:border-teal-500 hover:text-teal-500">Serviços</button>
                <button data-tab="financial" class="tab-button text-sm sm:text-base font-medium py-3 px-3 sm:px-5 border-b-2 border-transparent hover:border-teal-500 hover:text-teal-500">Financeiro</button>
                <button data-tab="term" class="tab-button text-sm sm:text-base font-medium py-3 px-3 sm:px-5 border-b-2 border-transparent hover:border-teal-500 hover:text-teal-500">Prazo e Rescisão</button>
                <button data-tab="obligations" class="tab-button text-sm sm:text-base font-medium py-3 px-3 sm:px-5 border-b-2 border-transparent hover:border-teal-500 hover:text-teal-500">Obrigações</button>
                <button data-tab="confidentiality" class="tab-button text-sm sm:text-base font-medium py-3 px-3 sm:px-5 border-b-2 border-transparent hover:border-teal-500 hover:text-teal-500">Confidencialidade</button>
                <button data-tab="signatures" class="tab-button text-sm sm:text-base font-medium py-3 px-3 sm:px-5 border-b-2 border-transparent hover:border-teal-500 hover:text-teal-500">Assinaturas</button>
                <button data-tab="admin-settings" class="tab-button text-sm sm:text-base font-medium py-3 px-3 sm:px-5 border-b-2 border-transparent hover:border-teal-500 hover:text-teal-500">Configurações do Admin</button>
            </nav>

            <main>
                <!-- Visão Geral -->
                <section id="overview" class="tab-content">
                    <div class="prose max-w-none">
                        <p class="text-slate-600 mb-6">Esta é uma visão geral dos termos mais importantes do contrato. Para detalhes completos, navegue pelas abas acima. Este painel interativo resume o acordo legal para facilitar a consulta e o entendimento mútuo.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-slate-100 p-6 rounded-lg">
                            <h3 class="font-bold text-lg mb-2 text-teal-700">Objeto Principal</h3>
                            <p id="overview-main-objective" class="text-slate-600">Gestão de Tráfego Pago (Facebook/Instagram Ads) para aumentar a visualização do perfil e gerar leads via WhatsApp.</p>
                        </div>
                        <div class="bg-slate-100 p-6 rounded-lg">
                            <h3 class="font-bold text-lg mb-2 text-teal-700">Valor Mensal (Atual)</h3>
                            <p id="overview-price" class="text-slate-600 text-2xl font-bold">--</p>
                            <p class="text-sm text-slate-500">Valor atual baseado na data de assinatura.</p>
                        </div>
                        <div class="bg-slate-100 p-6 rounded-lg">
                            <h3 class="font-bold text-lg mb-2 text-teal-700">Prazo do Contrato</h3>
                            <p class="text-slate-600 text-2xl font-bold">6 meses</p>
                            <p class="text-sm text-slate-500">Com renovação automática via Cartão de Crédito.</p>
                        </div>
                    </div>
                </section>

                <!-- Partes -->
                <section id="parties" class="tab-content hidden">
                    <div class="prose max-w-none">
                        <p class="text-slate-600 mb-6">As partes envolvidas neste contrato são o CONTRATANTE, o cliente que recebe os serviços, e o CONTRATADO, o profissional responsável pela execução. As informações de contato e identificação são fundamentais para a comunicação oficial entre ambos. Use o formulário abaixo para preencher os dados do CONTRATANTE.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="border border-slate-200 rounded-lg p-6">
                            <h3 class="font-bold text-xl mb-4 text-teal-700">CONTRATANTE</h3>
                            <div id="contratante-display">
                                <p><strong>Razão Social:</strong> <span id="display-nome-completo"></span></p>
                                <p><strong>Nome Fantasia:</strong> <span id="display-nome-fantasia"></span></p>
                                <p><strong>CNPJ:</strong> <span id="display-cnpj"></span></p>
                                <p><strong>Endereço:</strong> <span id="display-endereco"></span></p>
                                <p><strong>Telefone:</strong> <span id="display-telefone"></span></p>
                                <p><strong>E-mail:</strong> <span id="display-email"></span></p>
                                <button id="edit-contratante-btn" class="mt-4 px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50">Editar Dados do Contratante</button>
                                <button id="clear-current-contratante-btn" class="mt-4 ml-2 px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">Limpar & Arquivar Contratante Atual</button>
                            </div>

                            <div id="contratante-form" class="form-section hidden mt-4 p-4 border border-slate-300 rounded-lg bg-slate-50">
                                <h4 class="font-bold text-lg mb-4 text-teal-700">Preencher Dados do Contratante</h4>
                                <div class="input-group">
                                    <label for="input-nome-completo">Nome Completo/Razão Social:</label>
                                    <input type="text" id="input-nome-completo" placeholder="Nome Completo/Razão Social" autocomplete="off">
                                </div>
                                <div class="input-group">
                                    <label for="input-nome-fantasia">Nome Fantasia:</label>
                                    <input type="text" id="input-nome-fantasia" placeholder="Nome Fantasia" autocomplete="off">
                                </div>
                                <div class="input-group">
                                    <label for="input-cnpj">CNPJ:</label>
                                    <input type="text" id="input-cnpj" placeholder="CNPJ" autocomplete="off">
                                </div>
                                <div class="input-group">
                                    <label for="input-endereco">Endereço:</label>
                                    <input type="text" id="input-endereco" placeholder="Endereço Completo" autocomplete="off">
                                </div>
                                <div class="input-group">
                                    <label for="input-telefone">Telefone:</label>
                                    <input type="text" id="input-telefone" placeholder="Telefone" autocomplete="off">
                                </div>
                                <div class="input-group">
                                    <label for="input-email">E-mail:</label>
                                    <input type="email" id="input-email" placeholder="E-mail" autocomplete="off">
                                </div>
                                <button id="save-contratante-btn" class="mt-4 px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50">Salvar Dados</button>
                                <button id="cancel-edit-btn" class="mt-4 ml-2 px-4 py-2 bg-slate-300 text-slate-800 rounded-md hover:bg-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-opacity-50">Cancelar</button>
                            </div>
                        </div>
                        <div class="border border-slate-200 rounded-lg p-6">
                            <h3 class="font-bold text-xl mb-4 text-teal-700">CONTRATADO</h3>
                            <div id="contratado-display">
                                <p><strong>Nome Completo:</strong> <span id="display-nome-completo-contratado"></span></p>
                                <p><strong>CPF/CNPJ:</strong> <span id="display-cpf-contratado"></span></p>
                                <p><strong>Endereço:</strong> <span id="display-endereco-contratado"></span></p>
                                <p><strong>Telefone:</strong> <span id="display-telefone-contratado"></span></p>
                                <p><strong>E-mail:</strong> <span id="display-email-contratado"></span></p>
                                <button id="edit-contratado-btn" class="mt-4 px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50">Editar Dados do Contratado</button>
                                <button id="clear-current-contratado-btn" class="mt-4 ml-2 px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">Limpar dados do contrato</button>
                            </div>
                             <div id="contratado-form" class="form-section hidden mt-4 p-4 border border-slate-300 rounded-lg bg-slate-50">
                                <h4 class="font-bold text-lg mb-4 text-teal-700">Preencher Dados do Contratado</h4>
                                <div class="input-group">
                                    <label for="input-nome-completo-contratado">Nome Completo:</label>
                                    <input type="text" id="input-nome-completo-contratado" placeholder="Nome Completo" autocomplete="off">
                                </div>
                                <div class="input-group">
                                    <label for="input-cpf-contratado">CPF/CNPJ:</label>
                                    <input type="text" id="input-cpf-contratado" placeholder="CPF/CNPJ" autocomplete="off">
                                </div>
                                <div class="input-group">
                                    <label for="input-endereco-contratado">Endereço:</label>
                                    <input type="text" id="input-endereco-contratado" placeholder="Endereço Completo" autocomplete="off">
                                </div>
                                <div class="input-group">
                                    <label for="input-telefone-contratado">Telefone:</label>
                                    <input type="text" id="input-telefone-contratado" placeholder="Telefone" autocomplete="off">
                                </div>
                                <div class="input-group">
                                    <label for="input-email-contratado">E-mail:</label>
                                    <input type="email" id="input-email-contratado" placeholder="E-mail" autocomplete="off">
                                </div>
                                <button id="save-contratado-btn" class="mt-4 px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50">Salvar Dados</button>
                                <button id="cancel-edit-contratado-btn" class="mt-4 ml-2 px-4 py-2 bg-slate-300 text-slate-800 rounded-md hover:bg-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-opacity-50">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Serviços -->
                <section id="services" class="tab-content hidden prose max-w-none">
                       <p class="text-slate-600 mb-6">Esta seção detalha o escopo dos serviços a serem prestados. Define claramente o que está incluído no objeto do contrato, como a gestão das campanhas, e o que não está, como a otimização de landing pages, que pode ser contratada separadamente.</p>
                    <h2 class="text-teal-700">CLÁUSULA PRIMEIRA – DO OBJETO DO CONTRATO</h2>
                    <p id="clausula1-1-main" class="text-slate-800"></p>
                    <ul>
                        <li id="clausula1-1-a" class="text-slate-800"></li>
                        <li id="clausula1-1-b" class="text-slate-800"></li>
                    </ul>
                    <p class="text-slate-800">1.2. A gestão do tráfego pago incluirá a criação, configuração, monitoramento e otimização das campanhas nas plataformas mencionadas.</p>
                    <p class="text-slate-800">1.3. A criação de criativos (vídeos e outras peças) será realizada com colaboração mútua. A criação exclusiva de vídeos pelo CONTRATADO será mediante acordo prévio.</p>
                    <p class="text-slate-800">1.4. A otimização de páginas de destino (landing pages) <strong>NÃO está inclusa</strong> e será cobrada à parte, caso solicitada.</p>
                </section>

                <!-- Financeiro -->
                <section id="financial" class="tab-content hidden">
                    <div class="prose max-w-none">
                        <p class="text-slate-600 mb-6">Aqui estão definidos todos os aspectos financeiros do acordo. O sistema abaixo destaca dinamicamente o valor mensal aplicável com base na data atual, de acordo com os termos do contrato. Também esclarece a responsabilidade sobre o investimento em anúncios.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div id="price-1500" class="price-box border-2 border-slate-200 rounded-lg p-6 text-center">
                            <p class="text-sm text-slate-500">Se assinado até 30/06/2025</p>
                            <p class="text-4xl font-bold my-2"><span id="display-price-1500">R$ 1.500,00</span></p>
                            <p class="text-slate-600">por mês</p>
                        </div>
                        <div id="price-1900" class="price-box border-2 border-slate-200 rounded-lg p-6 text-center">
                            <p class="text-sm text-slate-500">Se assinado após 30/06/2025</p>
                            <p class="text-4xl font-bold my-2"><span id="display-price-1900">R$ 1.900,00</span></p>
                            <p class="text-slate-600">por mês</p>
                        </div>
                    </div>
                    <div class="prose max-w-none">
                      <p>2.2. Os pagamentos serão realizados mensalmente, com vencimento no mesmo dia de cada mês correspondente à data de assinatura.</p>
                      <p>2.3. Pagamentos via cartão de crédito podem ser feitos pelo link: <a href="https://www.asaas.com/c/922ne9tix6v8zm6c" target="_blank" class="text-teal-600 hover:underline">Link de Pagamento Asaas</a>.</p>
                      <p>2.4. Não haverá cobrança de taxa de setup ou ativação.</p>
                      <p>2.5. O <strong>CONTRATANTE é o único responsável pelo investimento em mídia paga</strong> (verba de anúncios), definindo o valor a ser investido.</p>
                    </div>
                </section>

                <!-- Prazo e Rescisão -->
                <section id="term" class="tab-content hidden">
                    <div class="prose max-w-none">
                        <p class="text-slate-600 mb-6">Esta seção governa a duração do contrato, as regras para sua renovação e as condições para rescisão. O gráfico abaixo ilustra a duração inicial do contrato, enquanto as cláusulas detalham as multas e procedimentos em caso de término antecipado.</p>
                    </div>
                    <div class="my-6">
                         <h3 class="font-bold text-lg mb-2 text-center text-teal-700">Duração Inicial do Contrato</h3>
                         <div class="chart-container">
                             <canvas id="termChart"></canvas>
                         </div>
                    </div>
                    <div class="prose max-w-none">
                        <h3 class="text-teal-700">Prazo e Renovação</h3>
                        <p>3.1. O Contrato tem prazo determinado de 6 (seis) meses.</p>
                        <p>3.2. A renovação é automática por iguais períodos se o pagamento for via Cartão de Crédito.</p>
                        <p>3.3. Pagamentos via PIX não geram renovação automática.</p>
                        <h3 class="text-teal-700 mt-4">Rescisão e Multas</h3>
                        <p>4.1. Rescisão imotivada pode ocorrer por qualquer parte com aviso prévio de 7 dias.</p>
                        <p>4.2. Em caso de rescisão antecipada pelo CONTRATANTE (antes dos 6 meses), haverá multa de <strong>2% do valor total restante</strong> do contrato.</p>
                        <p>4.3. Rescisão por justa causa (descumprimento grave) é imediata.</p>
                    </div>
                </section>

                <!-- Obrigações -->
                <section id="obligations" class="tab-content hidden">
                     <div class="prose max-w-none">
                        <p class="text-slate-600 mb-6">O sucesso da parceria depende do cumprimento das responsabilidades de cada parte. A seguir, as obrigações do CONTRATADO e do CONTRATANTE são apresentadas lado a lado para maior clareza e fácil consulta.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="border border-slate-200 rounded-lg p-6">
                            <h3 class="font-bold text-xl mb-4 text-teal-700">Obrigações do CONTRATADO</h3>
                            <ul class="list-disc list-inside space-y-2">
                                <li>Criar, configurar e gerenciar as campanhas.</li>
                                <li>Realizar acompanhamento diário e otimização.</li>
                                <li>Apresentar relatórios de desempenho.</li>
                                <li>Manter sigilo sobre informações confidenciais.</li>
                            </ul>
                        </div>
                        <div class="border border-slate-200 rounded-lg p-6">
                            <h3 class="font-bold text-xl mb-4 text-teal-700">Obrigações do CONTRATANTE</h3>
                            <ul class="list-disc list-inside space-y-2">
                                <li>Efetuar os pagamentos em dia.</li>
                                <li>Aprovar as verbas de investimento em mídia.</li>
                                <li>Fornecer informações, acessos e materiais necessários.</li>
                                <li>Não interferir nas campanhas sem alinhamento prévio.</li>
                             </ul>
                        </div>
                    </div>
                     <div class="prose max-w-none mt-6">
                        <p>8.3. As metas mensais (KPIs) serão estabelecidas em reunião de planejamento estratégico.</p>
                        <h3 class="text-teal-700 mt-4">Acessos e Propriedade Intelectual</h3>
                        <p>5.2. O acesso às contas será via agência ROI-360, exigindo login do Instagram e cartões virtuais.</p>
                        <p>7.1. Criativos fornecidos pela agência ROI-360 são de propriedade da agência.</p>
                        <p>7.2. Criativos fornecidos pelo CONTRATANTE são de sua propriedade.</p>
                        <p>7.3. Estratégias desenvolvidas pelo CONTRATADO durante a vigência do contrato, para o propósito da gestão de tráfego, são de sua propriedade intelectual, salvo acordo contrário por escrito.</p>
                    </div>
                </section>
                
                <!-- Confidencialidade -->
                <section id="confidentiality" class="tab-content hidden prose max-w-none">
                    <p class="text-slate-600 mb-6">A proteção de informações sensíveis e o cumprimento da legislação de proteção de dados são cruciais. Esta seção estabelece os deveres de confidencialidade mútua e a conformidade com a Lei Geral de Proteção de Dados (LGPD).</p>
                    <h2 class="text-teal-700">CLÁUSULA SEXTA – DA CONFIDENCIALIDADE E PROTEÇÃO DE DADOS</h2>
                    <p>6.1. As partes concordam em manter total confidencialidade sobre todas as informações estratégicas, comerciais, financeiras e de clientes da outra parte.</p>
                    <p>6.2. A confidencialidade é mútua, cobrindo informações estratégicas da agência e dados financeiros/de clientes do CONTRATANTE.</p>
                    <p>6.3. O CONTRATADO poderá utilizar informações de resultados e casos de sucesso do Studio D (CONTRATANTE) em seu portfólio ou materiais de divulgação, somente mediante prévia e expressa autorização do CONTRATANTE.</p>
                    <p>6.4. As partes se comprometem a cumprir com as disposições da Lei Geral de Proteção de Dados Pessoais (LGPD – Lei nº 13.709/2018), em relação aos dados pessoais que venham a ser coletados, tratados ou armazenados em decorrência deste Contrato. O CONTRATANTE é o Controlador dos Dados e o CONTRATADO atuará como Operador dos Dados, conforme definições da LGPD.</p>
                </section>

                <!-- Assinaturas -->
                <section id="signatures" class="tab-content hidden prose max-w-none">
                    <p class="text-slate-600 mb-6">Para formalizar o acordo, as partes e duas testemunhas devem assinar o instrumento. Utilize o campo abaixo para desenhar sua assinatura digitalmente. Lembre-se que esta é uma representação visual da assinatura para este aplicativo; a validade legal depende das leis locais.</p>
                    <p>E, por estarem assim justas e contratadas, as partes assinam o presente Contrato em 2 (duas) vias de igual teor e forma, na presença das duas testemunhas abaixo.</p>
                    <p id="signature-date-location" class="font-semibold"></p>
                    
                    <div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-12 text-center">
                        <div>
                            <p class="border-t border-slate-400 pt-2" id="contratante-assinatura-nome"></p>
                            <p class="text-sm text-slate-500">CONTRATANTE (CNPJ: <span id="contratante-assinatura-cnpj"></span>)</p>
                            <div class="mt-2" id="contratante-assinatura-display">
                                <!-- Assinatura do Contratante será exibida aqui -->
                            </div>
                            <div class="mt-4 flex flex-col items-center">
                                <canvas id="signature-canvas" class="signature-canvas w-full max-w-sm h-32 rounded-md" width="400" height="128"></canvas>
                                <div class="mt-2 flex space-x-2">
                                    <button id="clear-signature-btn" class="px-4 py-2 bg-slate-300 text-slate-800 rounded-md hover:bg-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-opacity-50">Limpar Assinatura</button>
                                    <button id="save-signature-btn" class="px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50">Salvar Assinatura</button>
                                </div>
                                <p class="text-sm text-slate-500 mt-2">Assinatura digital do CONTRATANTE</p>
                            </div>
                        </div>
                        <div>
                            <p class="border-t border-slate-400 pt-2" id="contratado-assinatura-nome"></p>
                            <p class="text-sm text-slate-500">CONTRATADO (CPF/CNPJ: <span id="contratado-assinatura-cpf"></span>)</p>
                        </div>
                    </div>

                    <h3 class="text-center mt-16 font-bold text-teal-700">TESTEMUNHAS</h3>
                     <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-12 text-center">
                        <div>
                            <p class="border-t border-slate-400 pt-2">Nome Completo:</p>
                            <p class="text-sm text-slate-500">CPF:</p>
                        </div>
                        <div>
                            <p class="border-t border-slate-400 pt-2">Nome Completo:</p>
                            <p class="text-sm text-slate-500">CPF:</p>
                        </div>
                    </div>
                    <div class="text-center mt-8">
                        <button id="generate-pdf-btn" class="px-6 py-3 bg-blue-600 text-white rounded-md text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Gerar Contrato em PDF</button>
                    </div>
                </section>

                <!-- Configurações do Admin -->
                <section id="admin-settings" class="tab-content hidden admin-section">
                    <div class="prose max-w-none">
                        <p class="text-slate-600 mb-6">Esta seção é para configurações do administrador. As alterações aqui afetam o conteúdo do contrato exibido e gerado em PDF para todos os clientes. As informações são salvas automaticamente no banco de dados.</p>
                    </div>
                    
                    <!-- Settings and Save Button Container -->
                    <div class="mb-8">
                        <div class="p-4 border border-slate-300 rounded-lg bg-slate-50">
                            <h4 class="font-bold text-lg mb-4 text-teal-700">Configurações de Preço</h4>
                            <div class="input-group">
                                <label for="admin-price-1500">Valor do Contrato (até 30/06/2025):</label>
                                <input type="number" id="admin-price-1500" placeholder="1500.00" step="0.01">
                            </div>
                            <div class="input-group">
                                <label for="admin-price-1900">Valor do Contrato (após 30/06/2025):</label>
                                <input type="number" id="admin-price-1900" placeholder="1900.00" step="0.01">
                            </div>
                        </div>

                        <div class="mt-6 p-4 border border-slate-300 rounded-lg bg-slate-50">
                            <h4 class="font-bold text-lg mb-4 text-teal-700">Configurações de Nícho e Serviço</h4>
                            <div class="input-group">
                                <label for="admin-main-objective-text">Objeto Principal do Contrato (Parágrafo inicial):</label>
                                <textarea id="admin-main-objective-text" rows="3" placeholder="O presente Contrato tem como objeto a prestação de serviços de Gestão de Tráfego Pago pelo CONTRATADO para o CONTRATANTE, visando..."></textarea>
                            </div>
                            <div class="input-group">
                                <label for="admin-objective-a">Objetivo Específico (a):</label>
                                <input type="text" id="admin-objective-a" placeholder="Aumento da visualização do perfil...">
                            </div>
                            <div class="input-group">
                                <label for="admin-objective-b">Objetivo Específico (b):</label>
                                <input type="text" id="admin-objective-b" placeholder="Geração de Leads via WhatsApp para...">
                            </div>
                        </div>

                        <div class="mt-6 p-4 border border-slate-300 rounded-lg bg-slate-50">
                            <h4 class="font-bold text-lg mb-4 text-teal-700">Configurações da Legenda do Cabeçalho</h4>
                            <div class="input-group">
                                <label for="admin-header-contratante-name">Nome da Empresa Contratante (na legenda):</label>
                                <input type="text" id="admin-header-contratante-name" placeholder="Studio D">
                            </div>
                            <div class="input-group">
                                <label for="admin-header-contratado-name">Nome do Contratado (na legenda):</label>
                                <input type="text" id="admin-header-contratado-name" placeholder="Matheus Henrique Laurindo">
                            </div>
                        </div>

                        <button id="save-admin-settings-btn" class="mt-6 px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50">Salvar Configurações Admin</button>
                    </div>

                    <!-- Client History Container -->
                    <div class="p-4 border border-slate-300 rounded-lg bg-slate-50">
                        <h4 class="font-bold text-lg mb-4 text-teal-700">Histórico de Clientes (Arquivados)</h4>
                        <div id="client-history-display" class="space-y-4">
                            <p class="text-slate-500">Nenhum cliente no histórico.</p>
                        </div>
                    </div>
                    
                    <!-- Contractor History Container -->
                    <div class="mt-6 p-4 border border-slate-300 rounded-lg bg-slate-50">
                        <h4 class="font-bold text-lg mb-4 text-teal-700">Histórico de Contratados</h4>
                        <div id="contractor-history-display" class="space-y-4">
                            <p class="text-slate-500">Nenhum contratado no histórico.</p>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables & Firebase Initialization ---
        let db, auth, userId, appId;
        let unsubscribeAdminSettings = null;
        let unsubscribeCurrentClient = null;
        let unsubscribeContratado = null;
        let unsubscribeClientHistory = null;
        let unsubscribeContractorHistory = null;
        
        const loadingOverlay = document.getElementById('loading-overlay');
        let contratanteAssinaturaDisplay;

        // --- Custom Notification System ---
        const notificationToast = document.getElementById('notification-toast');
        function showNotification(message, type = 'info', duration = 3000) {
            notificationToast.textContent = message;
            notificationToast.className = `show ${type}`;
            setTimeout(() => {
                notificationToast.className = notificationToast.className.replace('show', '');
            }, duration);
        }

        // Function to show/hide loading spinner
        function showLoading(show) {
            if(show) {
                loadingOverlay.style.display = 'flex';
                loadingOverlay.style.opacity = '1';
            } else {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 300);
            }
        }
        
        showLoading(true);

        async function initializeFirebase() {
             try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : { apiKey: "DEMO_KEY", authDomain: "DEMO.firebaseapp.com", projectId: "DEMO" };
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User is signed in with UID:", userId);
                        setupAllListeners();
                    } else {
                        console.log("No user signed in, attempting auth...");
                        // ENHANCED AUTH FLOW
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (error) {
                                // The environment's token may be invalid ('auth/invalid-claims'). This is an expected issue.
                                // We will log a less alarming message and always fall back to anonymous sign-in.
                                if (error.code !== 'auth/invalid-claims') {
                                     console.error("An unexpected error occurred during custom token sign-in:", error);
                                }
                                console.log("Custom token authentication failed. Falling back to anonymous sign-in.");
                                await signInAnonymously(auth).catch(anonError => {
                                    console.error("Critical: Fallback anonymous sign-in also failed:", anonError);
                                    showNotification("Falha crítica na autenticação.", "error");
                                    showLoading(false);
                                });
                            }
                        } else {
                            // No custom token, proceed with anonymous sign-in
                            await signInAnonymously(auth).catch(anonError => {
                                console.error("Anonymous sign-in failed:", anonError);
                                showNotification("Falha na autenticação anónima.", "error");
                                showLoading(false);
                            });
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("Erro ao conectar com o banco de dados.", "error");
                showLoading(false);
            }
        }
        
        function setupAllListeners() {
            if (unsubscribeAdminSettings) unsubscribeAdminSettings();
            if (unsubscribeCurrentClient) unsubscribeCurrentClient();
            if (unsubscribeContratado) unsubscribeContratado();
            if (unsubscribeClientHistory) unsubscribeClientHistory();
            if (unsubscribeContractorHistory) unsubscribeContractorHistory();

            listenForAdminSettings();
            listenForCurrentClient();
            listenForContratadoData();
            listenForClientHistory();
            listenForContractorHistory();
        }

        function displaySignature(dataURL) {
            if (!contratanteAssinaturaDisplay) {
                contratanteAssinaturaDisplay = document.getElementById('contratante-assinatura-display');
            }
            contratanteAssinaturaDisplay.innerHTML = '';
            if (dataURL) {
                const img = document.createElement('img');
                img.src = dataURL;
                img.alt = 'Assinatura do Contratante';
                img.classList.add('w-full', 'max-w-xs', 'h-auto', 'mx-auto', 'mt-2', 'border', 'border-slate-200', 'rounded-md');
                contratanteAssinaturaDisplay.appendChild(img);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeFirebase();
            
            document.getElementById('signature-date-location').textContent = `Blumenau, Santa Catarina, ${new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' })}.`;

            contratanteAssinaturaDisplay = document.getElementById('contratante-assinatura-display');

            // --- TAB NAVIGATION ---
            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.getAttribute('data-tab');
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    tabContents.forEach(content => {
                        content.classList.toggle('hidden', content.id !== target);
                    });
                });
            });
            
            // --- SIGNATURE CANVAS LOGIC ---
            const signatureCanvas = document.getElementById('signature-canvas');
            const signatureCtx = signatureCanvas.getContext('2d');
            const clearSignatureBtn = document.getElementById('clear-signature-btn');
            const saveSignatureBtn = document.getElementById('save-signature-btn');
            let drawing = false;

            const getCoords = (e) => {
                const rect = signatureCanvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            }

            const startDrawing = (e) => { e.preventDefault(); drawing = true; const { x, y } = getCoords(e); signatureCtx.moveTo(x, y); };
            const endDrawing = () => { drawing = false; signatureCtx.beginPath(); };

            const draw = (e) => {
                if (!drawing) return;
                e.preventDefault();
                const { x, y } = getCoords(e);
                signatureCtx.lineWidth = 2;
                signatureCtx.lineCap = 'round';
                signatureCtx.strokeStyle = '#000000';
                signatureCtx.lineTo(x, y);
                signatureCtx.stroke();
                signatureCtx.beginPath();
                signatureCtx.moveTo(x, y);
            };

            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mouseup', endDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseout', endDrawing);
            signatureCanvas.addEventListener('touchstart', startDrawing);
            signatureCanvas.addEventListener('touchend', endDrawing);
            signatureCanvas.addEventListener('touchmove', draw);

            clearSignatureBtn.addEventListener('click', () => {
                signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                contratanteAssinaturaDisplay.innerHTML = '';
            });

            saveSignatureBtn.addEventListener('click', async () => {
                if (!userId) { showNotification("Aguarde a autenticação...", "info"); return; }
                const dataURL = signatureCanvas.toDataURL('image/png');
                displaySignature(dataURL);
                
                const currentClientDocRef = doc(db, `artifacts/${appId}/users/${userId}/currentClient/active`);
                try {
                    await setDoc(currentClientDocRef, { signature: dataURL }, { merge: true });
                    showNotification("Assinatura salva com sucesso.", "success");
                } catch (error) {
                    console.error("Error saving signature:", error);
                    showNotification("Erro ao salvar assinatura.", "error");
                }
            });

            // --- ADMIN SETTINGS ---
            const saveAdminSettingsBtn = document.getElementById('save-admin-settings-btn');
            saveAdminSettingsBtn.addEventListener('click', async () => {
                if (!userId) { showNotification("Aguarde a autenticação...", "info"); return; }
                const settings = {
                    price1500: parseFloat(document.getElementById('admin-price-1500').value) || 1500,
                    price1900: parseFloat(document.getElementById('admin-price-1900').value) || 1900,
                    mainObjectiveText: document.getElementById('admin-main-objective-text').value,
                    objectiveA: document.getElementById('admin-objective-a').value,
                    objectiveB: document.getElementById('admin-objective-b').value,
                    headerContratanteName: document.getElementById('admin-header-contratante-name').value,
                    headerContratadoName: document.getElementById('admin-header-contratado-name').value
                };
                
                const adminSettingsRef = doc(db, `artifacts/${appId}/public/data/settings/admin`);
                try {
                    await setDoc(adminSettingsRef, settings, { merge: true });
                    showNotification("Configurações do Admin salvas com sucesso!", "success");
                } catch (error) {
                    console.error("Error saving admin settings:", error);
                    showNotification("Erro ao salvar configurações do Admin.", "error");
                }
            });
            
            // --- CONTRATANTE FORM ---
            const contratanteDisplay = document.getElementById('contratante-display');
            const contratanteForm = document.getElementById('contratante-form');
            const editContratanteBtn = document.getElementById('edit-contratante-btn');
            const saveContratanteBtn = document.getElementById('save-contratante-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const clearCurrentContratanteBtn = document.getElementById('clear-current-contratante-btn');

            editContratanteBtn.addEventListener('click', () => { contratanteDisplay.classList.add('hidden'); contratanteForm.classList.remove('hidden'); });
            cancelEditBtn.addEventListener('click', () => { contratanteForm.classList.add('hidden'); contratanteDisplay.classList.remove('hidden'); });
            
            saveContratanteBtn.addEventListener('click', async () => {
                if (!userId) { showNotification("Aguarde a autenticação...", "info"); return; }
                const data = {
                    nomeCompleto: document.getElementById('input-nome-completo').value,
                    nomeFantasia: document.getElementById('input-nome-fantasia').value,
                    cnpj: document.getElementById('input-cnpj').value,
                    endereco: document.getElementById('input-endereco').value,
                    telefone: document.getElementById('input-telefone').value,
                    email: document.getElementById('input-email').value,
                };

                const currentClientRef = doc(db, `artifacts/${appId}/users/${userId}/currentClient/active`);
                try {
                    await setDoc(currentClientRef, data, { merge: true });
                    showNotification("Dados do contratante salvos.", "success");
                    contratanteForm.classList.add('hidden');
                    contratanteDisplay.classList.remove('hidden');
                } catch(error) {
                    console.error("Error saving client data:", error);
                    showNotification("Erro ao salvar dados do contratante.", "error");
                }
            });
            
            clearCurrentContratanteBtn.addEventListener('click', async () => {
                if (!userId) { showNotification("Aguarde a autenticação...", "info"); return; }
                const currentClientRef = doc(db, `artifacts/${appId}/users/${userId}/currentClient/active`);
                try {
                    const clientDoc = await getDoc(currentClientRef);
                    if (clientDoc.exists() && clientDoc.data().nomeCompleto) {
                        const clientData = clientDoc.data();
                        const clientHistoryCollection = collection(db, `artifacts/${appId}/public/data/clients`);
                        await addDoc(clientHistoryCollection, clientData);
                        showNotification(`Cliente "${clientData.nomeCompleto}" arquivado.`, "info");
                    }
                    await deleteDoc(currentClientRef);
                    showNotification("Campos limpos. Pronto para novo cliente.", "success");
                } catch (error) {
                    console.error("Error clearing/archiving client:", error);
                    showNotification("Erro ao limpar dados do contratante.", "error");
                }
            });

            // --- CONTRATADO FORM ---
            const contratadoDisplay = document.getElementById('contratado-display');
            const contratadoForm = document.getElementById('contratado-form');
            const editContratadoBtn = document.getElementById('edit-contratado-btn');
            const saveContratadoBtn = document.getElementById('save-contratado-btn');
            const cancelEditContratadoBtn = document.getElementById('cancel-edit-contratado-btn');
            const clearCurrentContratadoBtn = document.getElementById('clear-current-contratado-btn');

            editContratadoBtn.addEventListener('click', () => { contratadoDisplay.classList.add('hidden'); contratadoForm.classList.remove('hidden'); });
            cancelEditContratadoBtn.addEventListener('click', () => { contratadoForm.classList.add('hidden'); contratadoDisplay.classList.remove('hidden'); });

            saveContratadoBtn.addEventListener('click', async () => {
                if (!userId) { showNotification("Aguarde a autenticação...", "info"); return; }
                const data = {
                    nomeCompleto: document.getElementById('input-nome-completo-contratado').value,
                    cpf: document.getElementById('input-cpf-contratado').value,
                    endereco: document.getElementById('input-endereco-contratado').value,
                    telefone: document.getElementById('input-telefone-contratado').value,
                    email: document.getElementById('input-email-contratado').value,
                };
                const contratadoRef = doc(db, `artifacts/${appId}/users/${userId}/contratado/details`);
                try {
                    await setDoc(contratadoRef, data, { merge: true });
                    showNotification("Dados do contratado salvos.", "success");
                    contratadoForm.classList.add('hidden');
                    contratadoDisplay.classList.remove('hidden');
                } catch(error) {
                    console.error("Error saving contractor data:", error);
                    showNotification("Erro ao salvar dados do contratado.", "error");
                }
            });

            clearCurrentContratadoBtn.addEventListener('click', async () => {
                if (!userId) { showNotification("Aguarde a autenticação...", "info"); return; }
                const contratadoRef = doc(db, `artifacts/${appId}/users/${userId}/contratado/details`);
                try {
                    const contratadoDoc = await getDoc(contratadoRef);
                    if (contratadoDoc.exists() && contratadoDoc.data().nomeCompleto) {
                        const contratadoData = contratadoDoc.data();
                        const contractorHistoryCollection = collection(db, `artifacts/${appId}/public/data/contractors`);
                        await addDoc(contractorHistoryCollection, contratadoData);
                        showNotification(`Contratado "${contratadoData.nomeCompleto}" arquivado.`, "info");
                    }
                    await deleteDoc(contratadoRef);
                    showNotification("Dados do contratado limpos.", "success");
                } catch (error) {
                    console.error("Error clearing/archiving contractor data:", error);
                    showNotification("Erro ao limpar/arquivar dados do contratado.", "error");
                }
            });
            
            // --- CHART.JS ---
            const termCtx = document.getElementById('termChart').getContext('2d');
            new Chart(termCtx, { type: 'bar', data: { labels: ['Prazo Inicial (Meses)'], datasets: [{ label: 'Duração', data: [6], backgroundColor: ['rgba(20, 184, 166, 0.6)'], borderColor: ['rgba(13, 148, 136, 1)'], borderWidth: 1 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 7, ticks: { stepSize: 1 } }, y: { grid: { display: false } } } } });
            
            // --- PDF GENERATION ---
            document.getElementById('generate-pdf-btn').addEventListener('click', async () => {
                 const elementsToHide = [
                     document.getElementById('edit-contratante-btn'), document.getElementById('clear-current-contratante-btn'), document.getElementById('contratante-form'),
                     document.getElementById('edit-contratado-btn'), document.getElementById('clear-current-contratado-btn'), document.getElementById('contratado-form'),
                     document.getElementById('clear-signature-btn'), document.getElementById('save-signature-btn'), document.getElementById('signature-canvas'),
                     document.getElementById('admin-settings'), ...document.querySelectorAll('.tab-button'), ...document.querySelectorAll('.client-history-buttons') 
                 ];

                elementsToHide.forEach(el => el && el.classList.add('hidden'));
                document.getElementById('contratante-display').classList.remove('hidden');
                document.getElementById('contratado-display').classList.remove('hidden');
                tabContents.forEach(content => { if (content.id !== 'admin-settings') { content.classList.remove('hidden'); } });

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const contentToCapture = document.querySelector('.bg-white.rounded-lg.shadow-lg');
                const pdfWidth = doc.internal.pageSize.getWidth();
                const margin = 10;
                
                try {
                    showNotification("Gerando PDF... por favor, aguarde.", "info", 5000);
                    const canvas = await html2canvas(contentToCapture, { scale: 2, useCORS: true });
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = pdfWidth - (margin * 2);
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    doc.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                    heightLeft -= doc.internal.pageSize.getHeight();

                    while (heightLeft > 0) {
                        position = -heightLeft;
                        doc.addPage();
                        doc.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                        heightLeft -= doc.internal.pageSize.getHeight();
                    }
                    doc.save('Contrato_Servicos_Trafego_Pago.pdf');
                } catch (error) {
                    console.error('Erro ao gerar PDF:', error);
                    showNotification('Houve um erro ao gerar o PDF.', "error");
                } finally {
                    elementsToHide.forEach(el => el && el.classList.remove('hidden'));
                    document.querySelector('[data-tab="signatures"]').click();
                }
            });

        }); // END DOMContentLoaded

        // --- Firestore Listeners & UI Update Functions ---

        function listenForAdminSettings() {
            if (!userId) return;
            const adminSettingsRef = doc(db, `artifacts/${appId}/public/data/settings/admin`);
            unsubscribeAdminSettings = onSnapshot(adminSettingsRef, (doc) => {
                const settings = doc.exists() ? doc.data() : getDefaultAdminSettings();
                applyAdminSettingsToUI(settings);
            }, console.error);
        }
        
        function listenForCurrentClient() {
            if (!userId) return;
            const currentClientRef = doc(db, `artifacts/${appId}/users/${userId}/currentClient/active`);
            unsubscribeCurrentClient = onSnapshot(currentClientRef, (doc) => {
                const clientData = doc.exists() ? doc.data() : getDefaultClientData();
                applyClientDataToUI(clientData);
                showLoading(false); 
            }, (error) => {
                console.error("Error listening to current client:", error);
                showLoading(false);
            });
        }
        
        function listenForContratadoData() {
            if (!userId) return;
            const contratadoRef = doc(db, `artifacts/${appId}/users/${userId}/contratado/details`);
            unsubscribeContratado = onSnapshot(contratadoRef, (doc) => {
                const contratadoData = doc.exists() ? doc.data() : getDefaultContratadoData();
                applyContratadoDataToUI(contratadoData);
            }, console.error);
        }

        function listenForClientHistory() {
            if (!userId) return;
            const clientHistoryCollection = collection(db, `artifacts/${appId}/public/data/clients`);
            unsubscribeClientHistory = onSnapshot(query(clientHistoryCollection), (querySnapshot) => {
                const history = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayClientHistory(history);
            }, console.error);
        }

        function listenForContractorHistory() {
            if (!userId) return;
            const contractorHistoryCollection = collection(db, `artifacts/${appId}/public/data/contractors`);
            unsubscribeContractorHistory = onSnapshot(query(contractorHistoryCollection), (querySnapshot) => {
                const history = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayContractorHistory(history);
            }, console.error);
        }

        function getDefaultAdminSettings() {
            return {
                price1500: 1500.00, price1900: 1900.00, mainObjectiveText: 'N/A',
                objectiveA: 'N/A', objectiveB: 'N/A',
                headerContratanteName: 'Contratante', headerContratadoName: 'Contratado',
            };
        }
        
        function getDefaultClientData() {
            return { nomeCompleto: '', nomeFantasia: '', cnpj: '', endereco: '', telefone: '', email: '', signature: '' };
        }

        function getDefaultContratadoData() {
            // This now returns empty fields to correctly clear the UI.
            return {
                nomeCompleto: '', cpf: '',
                endereco: '', telefone: '', email: ''
            };
        }

        function applyAdminSettingsToUI(settings) {
            document.getElementById('admin-price-1500').value = settings.price1500 || '';
            document.getElementById('admin-price-1900').value = settings.price1900 || '';
            document.getElementById('admin-main-objective-text').value = settings.mainObjectiveText || '';
            document.getElementById('admin-objective-a').value = settings.objectiveA || '';
            document.getElementById('admin-objective-b').value = settings.objectiveB || '';
            document.getElementById('admin-header-contratante-name').value = settings.headerContratanteName || '';
            document.getElementById('admin-header-contratado-name').value = settings.headerContratadoName || '';
            document.getElementById('overview-main-objective').textContent = settings.mainObjectiveText || 'N/A';
            document.getElementById('clausula1-1-main').textContent = `1.1. ${settings.mainObjectiveText || ''}`;
            document.getElementById('clausula1-1-a').textContent = `a) ${settings.objectiveA || ''}`;
            document.getElementById('clausula1-1-b').textContent = `b) ${settings.objectiveB || ''}`;
            document.getElementById('header-subtitle').textContent = `${settings.headerContratanteName || 'Contratante'} & ${settings.headerContratadoName || 'Contratado'}`;
            document.getElementById('display-price-1500').textContent = `R$ ${(settings.price1500 || 0).toFixed(2).replace('.', ',')}`;
            document.getElementById('display-price-1900').textContent = `R$ ${(settings.price1900 || 0).toFixed(2).replace('.', ',')}`;

            const deadline = new Date('2025-06-30T23:59:59-03:00');
            const now = new Date();
            const currentPrice = now <= deadline ? settings.price1500 : settings.price1900;
            document.getElementById('overview-price').textContent = `R$ ${(currentPrice || 0).toFixed(2).replace('.', ',')}`;
            document.getElementById('price-1500').classList.toggle('active', now <= deadline);
            document.getElementById('price-1500').classList.toggle('inactive', now > deadline);
            document.getElementById('price-1900').classList.toggle('active', now > deadline);
            document.getElementById('price-1900').classList.toggle('inactive', now <= deadline);
        }

        function applyClientDataToUI(data) {
            document.getElementById('display-nome-completo').textContent = data.nomeCompleto || '';
            document.getElementById('display-nome-fantasia').textContent = data.nomeFantasia || '';
            document.getElementById('display-cnpj').textContent = data.cnpj || '';
            document.getElementById('display-endereco').textContent = data.endereco || '';
            document.getElementById('display-telefone').textContent = data.telefone || '';
            document.getElementById('display-email').textContent = data.email || '';
            document.getElementById('input-nome-completo').value = data.nomeCompleto || '';
            document.getElementById('input-nome-fantasia').value = data.nomeFantasia || '';
            document.getElementById('input-cnpj').value = data.cnpj || '';
            document.getElementById('input-endereco').value = data.endereco || '';
            document.getElementById('input-telefone').value = data.telefone || '';
            document.getElementById('input-email').value = data.email || '';
            document.getElementById('contratante-assinatura-nome').textContent = data.nomeCompleto || 'Nome do Contratante';
            document.getElementById('contratante-assinatura-cnpj').textContent = data.cnpj || 'N/A';
            
            const signatureData = data.signature || '';
            displaySignature(signatureData);
            if (!signatureData) {
                 const ctx = document.getElementById('signature-canvas').getContext('2d');
                 ctx.clearRect(0,0, ctx.canvas.width, ctx.canvas.height);
            }
        }

        function applyContratadoDataToUI(data) {
            document.getElementById('display-nome-completo-contratado').textContent = data.nomeCompleto || '';
            document.getElementById('display-cpf-contratado').textContent = data.cpf || '';
            document.getElementById('display-endereco-contratado').textContent = data.endereco || '';
            document.getElementById('display-telefone-contratado').textContent = data.telefone || '';
            document.getElementById('display-email-contratado').textContent = data.email || '';
            document.getElementById('input-nome-completo-contratado').value = data.nomeCompleto || '';
            document.getElementById('input-cpf-contratado').value = data.cpf || '';
            document.getElementById('input-endereco-contratado').value = data.endereco || '';
            document.getElementById('input-telefone-contratado').value = data.telefone || '';
            document.getElementById('input-email-contratado').value = data.email || '';
            document.getElementById('contratado-assinatura-nome').textContent = data.nomeCompleto || 'Nome do Contratado';
            document.getElementById('contratado-assinatura-cpf').textContent = data.cpf || 'N/A';
        }
        
        function displayClientHistory(history) {
            const clientHistoryDisplay = document.getElementById('client-history-display');
            clientHistoryDisplay.innerHTML = history.length === 0 ? '<p class="text-slate-500">Nenhum cliente no histórico.</p>' : '';
            if (history.length === 0) return;

            clientHistoryDisplay.innerHTML = ''; // Clear previous entries
            history.forEach((client) => {
                const clientCard = document.createElement('div');
                clientCard.classList.add('border', 'border-slate-200', 'rounded-lg', 'p-4', 'bg-white');
                clientCard.innerHTML = `
                    <h5 class="font-bold text-md mb-2 text-teal-700">${client.nomeFantasia || client.nomeCompleto || 'N/A'}</h5>
                    <div class="space-y-1 text-sm">
                        <p><strong>Razão Social:</strong> ${client.nomeCompleto || 'N/A'}</p>
                        <p><strong>CNPJ:</strong> ${client.cnpj || 'N/A'}</p>
                        <p><strong>Endereço:</strong> ${client.endereco || 'N/A'}</p>
                        <p><strong>Telefone:</strong> ${client.telefone || 'N/A'}</p>
                        <p><strong>E-mail:</strong> ${client.email || 'N/A'}</p>
                    </div>
                    <div class="mt-3 flex space-x-2 client-history-buttons">
                        <button class="load-client-btn px-3 py-1 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600" data-id="${client.id}">Carregar</button>
                        <button class="remove-client-btn px-3 py-1 bg-red-500 text-white rounded-md text-sm hover:bg-red-600" data-id="${client.id}">Remover</button>
                    </div>`;
                clientHistoryDisplay.appendChild(clientCard);
            });
            
            document.querySelectorAll('.load-client-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.target.dataset.id;
                    const clientDocRef = doc(db, `artifacts/${appId}/public/data/clients/${docId}`);
                    try {
                        const clientDoc = await getDoc(clientDocRef);
                        if (clientDoc.exists()) {
                            const clientData = clientDoc.data();
                            const currentClientRef = doc(db, `artifacts/${appId}/users/${userId}/currentClient/active`);
                            await setDoc(currentClientRef, clientData);
                            showNotification(`Dados de "${clientData.nomeCompleto}" carregados!`, "success");
                            document.querySelector('[data-tab="parties"]').click(); 
                        }
                    } catch (error) { console.error("Error loading client from history:", error); showNotification("Erro ao carregar cliente.", "error"); }
                });
            });

            document.querySelectorAll('.remove-client-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.target.dataset.id;
                    const clientDocRef = doc(db, `artifacts/${appId}/public/data/clients/${docId}`);
                    try {
                        await deleteDoc(clientDocRef);
                        showNotification(`Cliente removido do histórico.`, "success");
                    } catch (error) { console.error("Error removing client from history:", error); showNotification("Erro ao remover cliente.", "error"); }
                });
            });
        }

        function displayContractorHistory(history) {
            const contractorHistoryDisplay = document.getElementById('contractor-history-display');
            contractorHistoryDisplay.innerHTML = history.length === 0 ? '<p class="text-slate-500">Nenhum contratado no histórico.</p>' : '';
            if (history.length === 0) return;

            contractorHistoryDisplay.innerHTML = ''; // Clear previous entries
            history.forEach((contractor) => {
                const contractorCard = document.createElement('div');
                contractorCard.classList.add('border', 'border-slate-200', 'rounded-lg', 'p-4', 'bg-white', 'space-y-1');
                contractorCard.innerHTML = `
                    <h5 class="font-bold text-md mb-2 text-teal-700">${contractor.nomeCompleto || 'N/A'}</h5>
                    <p class="text-sm"><strong>CPF/CNPJ:</strong> ${contractor.cpf || 'N/A'}</p>
                    <p class="text-sm"><strong>Endereço:</strong> ${contractor.endereco || 'N/A'}</p>
                    <p class="text-sm"><strong>Telefone:</strong> ${contractor.telefone || 'N/A'}</p>
                    <p class="text-sm"><strong>E-mail:</strong> ${contractor.email || 'N/A'}</p>
                `;
                contractorHistoryDisplay.appendChild(contractorCard);
            });
        }
    </script>
</body>
</html>
